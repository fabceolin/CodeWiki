# Story 1.2: Provider Configuration

## Status

Draft

## Story

**As a** CodeWiki user,
**I want** to configure the LLM provider type (API or Shell) via CLI,
**so that** I can choose how CodeWiki communicates with the LLM based on my setup.

## Acceptance Criteria

1. New config field `provider_type` with values: `api` (default) | `shell`
2. New config field `shell_command` for specifying CLI executable (default: `claude`)
3. New config field `shell_args` for CLI arguments (default: `["-p", "{prompt}", "--dangerously-skip-permissions"]`)
4. New config field `shell_timeout` for command timeout in seconds (default: 300)
5. CLI command `codewiki config set --provider <type>` works
6. CLI command `codewiki config set --shell-command <cmd>` works
7. CLI command `codewiki config set --shell-args <json>` works (JSON array format)
8. CLI command `codewiki config set --shell-timeout <seconds>` works
9. `codewiki config show` displays provider configuration
10. `codewiki config validate` checks if shell command exists when provider is `shell`
11. Configuration persists in `~/.codewiki/config.json`
12. API key is NOT required when `provider_type` is `shell`
13. Clear error message when API provider is used without API key configured

## Tasks / Subtasks

- [ ] Task 1: Extend Configuration model (AC: 1, 2, 3, 4)
  - [ ] Add `provider_type: str` field to `Configuration` class in `cli/models/config.py`
  - [ ] Add `shell_command: str` field with default `"claude"`
  - [ ] Add `shell_args: list[str]` field with default `["-p", "{prompt}", "--dangerously-skip-permissions"]`
  - [ ] Add `shell_timeout: int` field with default `300`
  - [ ] Update `to_dict()` and `from_dict()` methods
  - [ ] Update `is_complete()` to not require API key when provider is shell

- [ ] Task 2: Extend ConfigManager (AC: 11, 12, 13)
  - [ ] Add parameters to `save()` method in `config_manager.py`
  - [ ] Ensure backward compatibility with existing configs (missing fields get defaults)
  - [ ] Skip API key validation when provider_type is shell
  - [ ] Add clear error message when API provider used without API key

- [ ] Task 3: Extend CLI config commands (AC: 5, 6, 7, 8, 9)
  - [ ] Add `--provider` option to `config set` command
  - [ ] Add `--shell-command` option to `config set` command
  - [ ] Add `--shell-args` option to `config set` command (JSON array)
  - [ ] Add `--shell-timeout` option to `config set` command
  - [ ] Update `config show` to display new fields

- [ ] Task 4: Implement validation (AC: 10)
  - [ ] Add shell command existence check using `shutil.which()`
  - [ ] Display warning/error if command not found
  - [ ] Update `config validate` command

- [ ] Task 5: Extend core Config class (AC: 1, 2, 3, 4)
  - [ ] Add fields to `Config` dataclass in `src/config.py`
  - [ ] Update `Config.from_cli()` to accept new parameters

- [ ] Task 6: Add unit tests (AC: 1-13)
  - [ ] Test backward compatibility with configs missing new fields
  - [ ] Test validation of shell command existence
  - [ ] Test is_complete() with shell provider
  - [ ] Test error message for API provider without key

## Dev Notes

### Files to Modify

```
codewiki/cli/models/config.py      # Configuration dataclass
codewiki/cli/config_manager.py     # ConfigManager.save()
codewiki/cli/commands/config.py    # CLI commands
codewiki/src/config.py             # Core Config class
```

### Existing Pattern Reference

See `config_manager.py:84-111` for the existing `save()` method parameter pattern.

See `cli/commands/config.py` for existing Click command patterns.

### Configuration Schema Extension

```json
{
  "version": "1.0",
  "base_url": "...",
  "main_model": "...",
  "provider_type": "api",
  "shell_command": "claude",
  "shell_args": ["-p", "{prompt}", "--dangerously-skip-permissions"],
  "shell_timeout": 300
}
```

### Shell Provider Configuration Example

```json
{
  "version": "1.0",
  "provider_type": "shell",
  "shell_command": "claude",
  "shell_args": ["-p", "{prompt}", "--dangerously-skip-permissions"],
  "shell_timeout": 1800
}
```

Note: When `provider_type` is `"shell"`:
- `base_url`, `main_model`, `cluster_model`, `fallback_model` are ignored
- API key is not required
- `shell_command` must exist in PATH

### CLI Usage Examples

```bash
# Switch to shell provider
codewiki config set --provider shell

# Customize shell command
codewiki config set --shell-command /usr/local/bin/claude

# Set longer timeout for large repos
codewiki config set --shell-timeout 3600

# View current configuration
codewiki config show

# Validate configuration
codewiki config validate
```

### Validation Logic

```python
def validate_shell_provider(config: Configuration) -> list[str]:
    """Validate shell provider configuration."""
    errors = []

    if config.provider_type != "shell":
        return errors

    # Check command exists
    import shutil
    if not shutil.which(config.shell_command):
        errors.append(f"Shell command not found: {config.shell_command}")

    # Check {prompt} placeholder in args
    if not any("{prompt}" in arg for arg in config.shell_args):
        errors.append("shell_args must contain {prompt} placeholder")

    return errors
```

### Testing

- Test file: `tests/cli/test_config_commands.py`
- Test backward compatibility with configs missing new fields
- Test validation of shell command existence

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-01-20 | 0.2 | Added shell_args field and validation details | Sarah (PO) |
| 2025-01-20 | 0.3 | Applied validation fixes: added AC 7 for --shell-args, AC 13 for API error, mapped Task 6 to ACs | Sarah (PO) |
