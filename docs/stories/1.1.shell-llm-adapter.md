# Story 1.1: Shell LLM Adapter

## Status

Draft

## Story

**As a** CodeWiki developer,
**I want** an adapter that executes LLM calls via shell command,
**so that** users can use locally installed CLI tools (like `claude`) instead of HTTP APIs.

## Acceptance Criteria

1. Adapter executes `claude` CLI with prompt passed via `-p` flag
2. Adapter captures stdout as response text
3. Adapter handles command execution errors gracefully (non-zero exit codes)
4. Adapter supports timeout configuration (default 5 minutes)
5. Adapter handles large prompts (>100KB) by falling back to stdin mode
6. Response text is returned stripped of whitespace
7. Adapter is async-compatible for integration with existing async codebase

## Tasks / Subtasks

- [ ] Task 1: Create `shell_adapter.py` module (AC: 1, 2, 6)
  - [ ] Create `ShellLLMAdapter` class in `codewiki/src/be/shell_adapter.py`
  - [ ] Create `ShellExecutionError` exception class in same module
  - [ ] Implement `execute()` method using `asyncio.create_subprocess_exec`
  - [ ] Implement prompt passing via `-p` flag with `{prompt}` substitution
  - [ ] Implement stdout capture with explicit UTF-8 encoding
  - [ ] Add `--dangerously-skip-permissions` flag for non-interactive execution
  - [ ] Add logging for command execution (log command, timeout, exit code)

- [ ] Task 2: Implement error handling (AC: 3, 4)
  - [ ] Handle non-zero exit codes with descriptive `ShellExecutionError`
  - [ ] Implement configurable timeout with `asyncio.wait_for`
  - [ ] Handle `FileNotFoundError` when command not found
  - [ ] Handle `asyncio.TimeoutError` with process termination (`proc.kill()`)

- [ ] Task 3: Implement large prompt handling (AC: 5)
  - [ ] Detect prompts > 100KB (MAX_ARG_SIZE constant)
  - [ ] Fall back to stdin mode: remove `-p {prompt}` from args, use `proc.communicate(input=prompt)`
  - [ ] Test with various prompt sizes (1KB, 50KB, 150KB)

- [ ] Task 4: Implement message formatting (AC: 1)
  - [ ] Create `_format_messages_for_cli()` helper
  - [ ] Format system messages as "System: {content}"
  - [ ] Format assistant messages as "Assistant: {content}"
  - [ ] Format user messages as plain content
  - [ ] Join with double newlines

- [ ] Task 5: Add unit tests (AC: 7)
  - [ ] Test successful command execution
  - [ ] Test async execution with event loop
  - [ ] Test timeout handling
  - [ ] Test error scenarios (non-zero exit, command not found)
  - [ ] Test large prompt fallback to stdin
  - [ ] Test message formatting

## Dev Notes

### Target File Location

```
codewiki/src/be/shell_adapter.py
```

### Reference Implementation

Use `the_edge_agent/python/src/the_edge_agent/actions/llm_actions.py` as reference:

**Key functions to adapt:**

```python
# Lines 205-218: Message formatting
def _format_messages_for_cli(messages: list) -> str:
    parts = []
    for msg in messages:
        role = msg.get("role", "user")
        content = msg.get("content", "")
        if role == "system":
            parts.append(f"System: {content}")
        elif role == "assistant":
            parts.append(f"Assistant: {content}")
        else:
            parts.append(content)
    return "\n\n".join(parts)

# Lines 153-161: Claude CLI config
"claude": {
    "command": "claude",
    "args": ["-p", "{prompt}", "--dangerously-skip-permissions"],
    "timeout": 108000,
}

# Lines 293-311: Large prompt detection and fallback
MAX_ARG_SIZE = 100000  # ~100KB safe limit for shell args
if prompt_in_args and len(prompt_text) > MAX_ARG_SIZE:
    prompt_in_args = False
    stdin_mode = "pipe"
```

**Core execution pattern (Lines 301-354):**

```python
if prompt_in_args:
    proc = subprocess.Popen(
        full_command,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        env=env,
    )
    stdout, stderr = proc.communicate(timeout=provider_timeout)
elif stdin_mode == "pipe":
    proc = subprocess.Popen(
        full_command,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        env=env,
    )
    stdout, stderr = proc.communicate(input=prompt_text, timeout=provider_timeout)

if proc.returncode != 0:
    return {"error": f"Shell command failed (exit {proc.returncode}): {stderr}", "success": False}

return {"content": stdout.strip(), "usage": {}, "provider": "shell"}
```

### Async Adaptation

The reference uses sync `subprocess.Popen`. For CodeWiki, adapt to async:

```python
import asyncio

async def execute(self, messages: list[dict], timeout: int = 300) -> str:
    prompt_text = self._format_messages(messages)

    # Build command
    cmd = [self.command] + [
        arg.replace("{prompt}", prompt_text) if "{prompt}" in arg else arg
        for arg in self.args
    ]

    # Execute
    proc = await asyncio.create_subprocess_exec(
        *cmd,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )

    try:
        stdout, stderr = await asyncio.wait_for(
            proc.communicate(),
            timeout=timeout
        )
    except asyncio.TimeoutError:
        proc.kill()
        raise ShellExecutionError(f"Command timed out after {timeout}s")

    if proc.returncode != 0:
        raise ShellExecutionError(f"Exit {proc.returncode}: {stderr.decode()}")

    return stdout.decode().strip()
```

### Claude CLI Reference

```bash
# Basic usage
claude -p "Your prompt here" --dangerously-skip-permissions

# The --dangerously-skip-permissions flag is REQUIRED for non-interactive use
# Without it, claude will prompt for confirmation
```

### Testing

- Test file location: `tests/test_shell_adapter.py`
- Framework: pytest with pytest-asyncio
- Mock subprocess calls using `unittest.mock.patch`

```python
@pytest.mark.asyncio
async def test_successful_execution():
    with patch('asyncio.create_subprocess_exec') as mock_exec:
        mock_proc = AsyncMock()
        mock_proc.communicate.return_value = (b"Hello from Claude", b"")
        mock_proc.returncode = 0
        mock_exec.return_value = mock_proc

        adapter = ShellLLMAdapter()
        result = await adapter.execute([{"role": "user", "content": "Hello"}])

        assert result == "Hello from Claude"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 0.1 | Initial story creation | Sarah (PO) |
| 2025-01-20 | 0.2 | Added reference implementation from the_edge_agent | Sarah (PO) |
| 2025-01-20 | 0.3 | Applied validation fixes: clarified exception location, encoding, stdin fallback, async test | Sarah (PO) |
